<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>Cong Chi√™ng Tuner ‚Äì Mobile Ready</title>

  <!-- √âP CHUY·ªÇN SANG HTTPS V·ªöI DOMAIN khktbuithanhluan -->
  <script>
    (function(){
      // Kh√¥ng ch·∫∑n khi ch·∫°y tr√™n file:// ho·∫∑c localhost (dev)
      if (location.protocol === 'http:' &&
          location.hostname !== 'localhost' &&
          location.hostname !== '127.0.0.1') {

        // N·∫øu b·∫°n mu·ªën domain ch√≠nh l√† khktbuithanhluan (vd: https://khktbuithanhluan)
        var newUrl = 'https://khktbuithanhluan' + location.pathname + location.search + location.hash;
        location.replace(newUrl);
      }
    })();
  </script>

  <style>
    :root{
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --bg:#0f172a;
      --accent:#2563eb;
      --accent-soft:#dbeafe;
      --danger:#dc2626;
      --success:#16a34a;
      --warning:#eab308;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;
      color:var(--ink);
      background:radial-gradient(circle at top left,#1e293b,#020617 50%, #020617 100%);
      min-height:100vh;
    }
    .page{
      max-width:1120px;
      margin:16px auto;
      padding:16px;
      border-radius:20px;
      background:linear-gradient(180deg,#f9fafb,#e5e7eb);
      box-shadow:0 16px 40px rgba(15,23,42,.6);
    }
    @media(max-width:640px){
      .page{
        margin:0;
        border-radius:0;
        min-height:100vh;
        box-shadow:none;
      }
    }
    h1{
      margin:0 0 4px;
      font-size:24px;
      font-weight:800;
      letter-spacing:-.03em;
      color:#0b1120;
    }
    @media(min-width:720px){
      h1{ font-size:28px; }
    }
    .subtitle{
      margin:0;
      font-size:13px;
      color:var(--muted);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(15,23,42,.03);
      font-size:11px;
      color:var(--muted);
    }
    .row{ display:grid; gap:12px; }
    .row.cols-2, .row.cols-3{
      grid-template-columns:1fr;
    }
    @media(min-width:960px){
      .row.cols-2{ grid-template-columns:1.4fr 1.6fr; }
      .row.cols-3{ grid-template-columns:repeat(3,1fr); }
    }
    .card{
      background:#ffffff;
      border:1px solid rgba(226,232,240,.9);
      border-radius:16px;
      box-shadow:0 8px 24px rgba(15,23,42,.06);
      padding:12px 12px 10px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at top right,rgba(129,140,248,.14),transparent 60%);
      opacity:.5;
      pointer-events:none;
    }
    .card > *{ position:relative; z-index:1; }

    .btn{
      border:1px solid transparent;
      color:#fff;
      background:var(--accent);
      padding:9px 13px;
      border-radius:999px;
      font-weight:600;
      cursor:pointer;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition:all .15s ease;
      box-shadow:0 6px 14px rgba(37,99,235,.35);
      text-align:center;
    }
    .btn.ghost{
      background:#fff;
      color:var(--ink);
      border-color:rgba(148,163,184,.8);
      box-shadow:none;
    }
    .btn.sm{
      padding:7px 10px;
      font-size:12px;
      box-shadow:none;
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }
    @media(max-width:640px){
      .btn, .btn.sm{
        width:100%;
      }
    }
    .field{
      width:100%;
      padding:9px 11px;
      border:1px solid var(--line);
      border-radius:999px;
      font:inherit;
      font-size:13px;
      background:#f9fafb;
      transition:all .12s ease;
    }
    .field:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(37,99,235,.25);
      background:#fff;
    }
    .label{
      font-size:11px;
      color:var(--muted);
      margin-bottom:4px;
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .small{
      font-size:12px;
      color:var(--muted);
    }
    .grid3{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:6px;
      text-align:center;
    }
    @media(max-width:480px){
      .grid3{ grid-template-columns:repeat(2,1fr); }
    }
    .pill{
      padding:8px 9px;
      border:1px solid rgba(226,232,240,.9);
      border-radius:14px;
      background:rgba(248,250,252,.95);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th,td{
      padding:7px 8px;
      border-top:1px solid rgba(226,232,240,.9);
      text-align:left;
    }
    th{
      background:#f8fafc;
      font-weight:600;
      position:sticky;
      top:0;
      z-index:1;
    }
    .needleWrap{
      position:relative;
      height:150px;
      margin-top:4px;
    }
    @media(min-width:720px){
      .needleWrap{ height:160px; }
    }
    .needleDial{
      position:absolute;
      inset:0;
      display:flex;
      align-items:flex-end;
      justify-content:center;
    }
    .needleArc{
      width:220px;
      height:110px;
      border-radius:220px 220px 0 0;
      border:2px solid rgba(203,213,225,.9);
      border-bottom:none;
      background:radial-gradient(circle at top,#eff6ff,#ffffff);
    }
    .needle{
      width:3px;
      height:100px;
      background:linear-gradient(180deg,var(--accent),#1d4ed8);
      transform-origin:bottom center;
      border-radius:999px;
      box-shadow:0 0 0 1px rgba(15,23,42,.14);
      transition:transform .08s linear;
    }
    canvas{
      display:block;
      width:100%;
      background:radial-gradient(circle at top,#eff6ff,#ffffff);
      border:1px solid rgba(226,232,240,.9);
      border-radius:12px;
    }
    .advice-box{
      margin-top:8px;
      padding:9px 10px;
      border-radius:14px;
      font-size:13px;
      line-height:1.5;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .advice-title{
      font-weight:700;
    }
    .chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .chip{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      background:#e5e7eb;
      color:#111827;
    }
    #micStatus{
      margin-top:4px;
      font-size:11px;
      color:#6b7280;
    }
  </style>
</head>
<body>
<div class="page">
  <header style="display:flex; gap:12px; align-items:flex-start; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap;">
    <div>
      <div class="badge">
        <span>üõ†Ô∏è C√¥ng c·ª• th·ª≠ nghi·ªám</span>
        <span>Cong Chi√™ng Tuner</span>
      </div>
      <h1>C√¥ng c·ª• ch·ªânh & ph√¢n t√≠ch C·ªìng Chi√™ng</h1>
      <p class="subtitle">
        Ghi √¢m l√†m chu·∫©n theo t·ª´ng chi√™ng, so s√°nh t·∫ßn s·ªë, ƒëo ƒë·ªô ng√¢n (RT60) v√† xem ph·ªï ‚Äì t·ªëi ∆∞u cho d√†n chi√™ng th·ª±c t·∫ø, d√πng ƒë∆∞·ª£c tr√™n ƒëi·ªán tho·∫°i.
      </p>
      <div id="micStatus">(Mic ch∆∞a kh·ªüi t·∫°o)</div>
    </div>
  </header>

  <!-- H√ÄNG 1: B·ªô chi√™ng / Chi√™ng / H∆∞·ªõng d·∫´n -->
  <section class="row cols-3" style="margin-bottom:12px;">
    <div class="card">
      <div class="label">B·ªô Chi√™ng</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <select id="selSet" class="field" style="flex:1 1 140px;"></select>
        <button id="btnAddSet" class="btn ghost sm" style="flex:0 0 auto;">+ B·ªô</button>
      </div>
    </div>

    <div class="card">
      <div class="label">Chi√™ng m·ª•c ti√™u</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <select id="selItem" class="field" style="flex:1 1 140px;"></select>
        <button id="btnAddItem" class="btn ghost sm" style="flex:0 0 auto;">+ Chi√™ng</button>
      </div>
      <div style="margin-top:6px;">
        <div class="label">T·∫ßn s·ªë m·ª•c ti√™u (Hz)</div>
        <input id="inpTargetHz" type="number" step="0.01" class="field" />
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
          <button id="btnRecordRef" class="btn sm">
            üéØ Ghi √¢m l√†m chu·∫©n (‚âà5s)
          </button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="label">G·ª£i √Ω thao t√°c</div>
      <ul class="small" style="margin:0 0 0 16px; padding:0; line-height:1.6;">
        <li>D√πng tai nghe Bluetooth <b>kh√¥ng</b> ·∫£nh h∆∞·ªüng v√¨ app ch·ªâ thu mic, kh√¥ng ph√°t ng∆∞·ª£c.</li>
        <li>Gi·ªØ ƒëi·ªán tho·∫°i c√°ch chi√™ng kho·∫£ng 0.5‚Äì1.5m, tr√°nh che mic.</li>
        <li>G√µ t·ª´ng chi√™ng ri√™ng l·∫ª khi ƒëo, kh√¥ng ƒë·ªÉ chi√™ng kh√°c rung theo.</li>
      </ul>
    </div>
  </section>

  <!-- H√ÄNG 2: Upload file -->
  <section class="card" style="margin-bottom:12px;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
      <div style="flex:1 1 200px;">
        <div class="label">T·∫£i file √¢m thanh (WAV/MP3)</div>
        <div class="small">
          H·ªá th·ªëng s·∫Ω ph√¢n t√≠ch <b>f0</b>, <b>spectral centroid</b> v√† <b>RT60</b>. C√≥ th·ªÉ ƒë·∫∑t f0 l√†m chu·∫©n cho chi√™ng ƒëang ch·ªçn.
        </div>
      </div>
      <label class="btn ghost sm" style="flex:0 0 auto;">
        üìÅ Ch·ªçn file‚Ä¶
        <input id="fileInput" type="file" accept="audio/*" style="display:none;" />
      </label>
    </div>
    <div id="fileSummary" class="row cols-3" style="margin-top:8px; display:none; gap:6px;">
      <div class="pill">
        <div class="small">File</div>
        <div id="sumName" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
      </div>
      <div class="pill">
        <div class="small">f0 ∆∞·ªõc l∆∞·ª£ng</div>
        <div id="sumF0"></div>
      </div>
      <div class="pill">
        <div class="small">Centroid</div>
        <div id="sumCentroid"></div>
      </div>
      <div class="pill">
        <div class="small">RT60 ~</div>
        <div id="sumRT60"></div>
      </div>
    </div>
  </section>

  <!-- H√ÄNG 3: Tuner + Ph·ªï -->
  <section class="row cols-2" style="margin-bottom:12px;">
    <!-- Tuner -->
    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
        <div>
          <div class="label">ƒê·ªô l·ªách so v·ªõi chu·∫©n</div>
          <div class="chip-row">
            <div class="chip">Mic live</div>
            <div class="chip">Auto b·∫Øt b·ªìi √¢m g·∫ßn chu·∫©n</div>
          </div>
        </div>
        <div style="display:flex; gap:6px; flex-wrap:wrap; width:100%; max-width:260px;">
          <button id="btnStart" class="btn sm" style="flex:1 1 120px;">üéô B·∫Øt ƒë·∫ßu</button>
          <button id="btnStop" class="btn ghost sm" style="flex:1 1 120px;">‚èπ D·ª´ng</button>
        </div>
      </div>

      <div class="needleWrap">
        <div class="needleDial"><div class="needleArc"></div></div>
        <div class="needleDial"><div id="needle" class="needle"></div></div>
      </div>

      <div class="grid3" style="margin-top:8px;">
        <div class="pill">
          <div class="small">T·∫ßn s·ªë ƒëo</div>
          <div id="measHz" style="font-weight:700; font-size:17px;">‚Äî Hz</div>
        </div>
        <div class="pill">
          <div class="small">M·ª•c ti√™u</div>
          <div id="targetHz" style="font-weight:700; font-size:17px;">‚Äî Hz</div>
        </div>
        <div class="pill">
          <div class="small">Sai s·ªë</div>
          <div id="detune" style="font-weight:700; font-size:17px;">‚Äî¬¢</div>
        </div>
      </div>
      <div class="small" id="stabilityTxt" style="margin-top:4px;">ƒê·ªô ·ªïn ƒë·ªãnh: ‚Äî%</div>

      <div id="adviceBox" class="advice-box" style="background:#f9fafb; border:1px dashed #cbd5f5;">
        <div id="adviceTitle" class="advice-title">Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªß ·ªïn ƒë·ªãnh.</div>
        <div id="adviceDetail" class="small">
          H√£y g√µ chi√™ng 2‚Äì3 l·∫ßn, gi·ªØ kho·∫£ng c√°ch mic c·ªë ƒë·ªãnh ƒë·ªÉ h·ªá th·ªëng b·∫Øt ƒë∆∞·ª£c √¢m ·ªïn ƒë·ªãnh r·ªìi ƒë∆∞a ra g·ª£i √Ω.
        </div>
      </div>

      <div style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <button id="btnQuickDecay" class="btn ghost sm" style="flex:1 1 140px;">‚è± ƒêo ƒë·ªô ng√¢n nhanh (RT60)</button>
        <span class="small" style="flex:1 1 160px;">B·∫•m r·ªìi g√µ 1 ph√°t, ƒë·ªÉ chi√™ng ng√¢n t·ª± nhi√™n ~5s.</span>
      </div>
    </div>

    <!-- Ph·ªï & Centroid -->
    <div class="card">
      <div style="display:flex; align-items:baseline; justify-content:space-between;">
        <div>
          <div class="label">Ph·ªï & trung t√¢m ph·ªï</div>
          <div style="font-weight:700; font-size:17px;">Centroid: <span id="centroidHz">‚Äî</span> Hz</div>
        </div>
        <div class="small">dBFS</div>
      </div>
      <div style="margin-top:8px;">
        <canvas id="specCanvas"></canvas>
      </div>
      <div class="small" style="margin-top:4px;">
        N·∫øu ƒë√£ t·∫£i file, ∆∞u ti√™n hi·ªÉn th·ªã ph·ªï c·ªßa file. Khi b·∫≠t Mic, chuy·ªÉn sang ph·ªï live.
      </div>
    </div>
  </section>

  <!-- H√ÄNG 4: B·∫£ng chi√™ng + RT60 -->
  <section class="row cols-2" style="margin-bottom:12px;">
    <div class="card">
      <div class="label" style="margin-bottom:4px;">B·ªô chi√™ng hi·ªán t·∫°i</div>
      <div style="max-height:260px; overflow:auto;">
        <table>
          <thead>
          <tr><th>Nh√£n</th><th>Hz</th><th>Ch·ªçn</th></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; flex-wrap:wrap; gap:8px;">
        <div style="flex:1 1 150px;">
          <div class="label">ƒê·ªô ng√¢n (RT60) ‚Äì Mic</div>
          <div class="small">B·∫•m ‚ÄúB·∫Øt ƒë·∫ßu ƒëo‚Äù r·ªìi g√µ m·ªôt ph√°t, ƒë·ªÉ chi√™ng ng√¢n t·ª± nhi√™n trong kho·∫£ng 4‚Äì6s.</div>
        </div>
        <div style="display:flex; gap:6px; flex-wrap:wrap; width:100%; max-width:260px;">
          <button id="btnStartDecay" class="btn sm" style="flex:1 1 120px;">‚ñ∂ B·∫Øt ƒë·∫ßu ƒëo</button>
          <button id="btnStopDecay" class="btn ghost sm" style="flex:1 1 120px;">‚èπ K·∫øt th√∫c</button>
        </div>
      </div>
      <div class="row cols-3">
        <div class="pill">
          <div class="small">RT60 (mic)</div>
          <div id="rt60Mic" style="font-weight:700; font-size:17px;">‚Äî</div>
        </div>
        <div class="pill">
          <div class="small">Ph∆∞∆°ng ph√°p</div>
          <div id="rtMethod" style="font-weight:600;">‚Äî</div>
        </div>
        <div class="pill">
          <div class="small">RT60 (file)</div>
          <div id="rt60File" style="font-weight:700; font-size:17px;">‚Äî</div>
        </div>
      </div>
      <div class="small" style="margin-top:4px;">
        RT60 l√† gi√° tr·ªã t∆∞∆°ng ƒë·ªëi, ph·ª• thu·ªôc kh√¥ng gian/thi·∫øt b·ªã. N√™n ƒëo 3‚Äì5 l·∫ßn v√† l·∫•y trung v·ªã ƒë·ªÉ ƒë√°nh gi√°.
      </div>
    </div>
  </section>

  <!-- H√ÄNG 5: Ghi ch√∫ -->
  <section class="card small">
    <div style="font-weight:600; margin-bottom:4px;">G·ª£i √Ω k·ªπ thu·∫≠t</div>
    <ul style="margin:0 0 0 18px; padding:0; line-height:1.6;">
      <li>Centroid cao ‚Üí √¢m s√°ng h∆°n; centroid th·∫•p ‚Üí √¢m tr·∫ßm/t·ªëi h∆°n.</li>
      <li>So s√°nh centroid & RT60 gi·ªØa c√°c chi√™ng c√πng b·∫≠c ƒë·ªÉ ch·ªçn chi√™ng ƒë·ªìng ƒë·ªÅu.</li>
      <li>N√™n ƒëo nhi·ªÅu l·∫ßn cho m·ªói chi√™ng r·ªìi l·∫•y trung b√¨nh/median ƒë·ªÉ quy·∫øt ƒë·ªãnh.</li>
    </ul>
  </section>
</div>

<script>
/* ==== Utility ==== */
const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));
const log2=(x)=>Math.log(x)/Math.log(2);
const centsDiff=(f,ref)=>(ref>0&&f>0?1200*log2(f/ref):0);
const EPS=1e-12;
const toDB=(x)=>20*Math.log10(Math.max(x,EPS));
const fromDB=(db)=>Math.pow(10, db/20);
function rms(buf){
  let s=0;
  for(let i=0;i<buf.length;i++) s+=buf[i]*buf[i];
  return Math.sqrt(s/buf.length);
}

/* C·ªë g·∫Øng k√©o f ƒëo ƒë∆∞·ª£c v·ªÅ b·∫≠c h√†i g·∫ßn v·ªõi target nh·∫•t */
function snapToTargetHarmonic(f, target) {
  if (!f || !isFinite(f) || !target || !isFinite(target) || target <= 0) return f;
  const ratio = f / target;
  if (ratio > 0.8 && ratio < 1.2) return f;

  let bestF = f;
  let bestDiff = Math.abs(f - target);

  for (let n = 2; n <= 6; n++) {
    const down = f / n;
    const up   = f * n;
    const cand = [down, up];
    for (const cf of cand) {
      if (cf <= 0 || !isFinite(cf)) continue;
      const diff = Math.abs(cf - target);
      if (diff < bestDiff * 0.6) {
        bestDiff = diff;
        bestF = cf;
      }
    }
  }
  return bestF;
}

/* ==== Local Storage (B·ªô chi√™ng) ==== */
const LS_KEY='cong-chieng-tuner-sets-v2-html';
const DEFAULT_SET={
  id:'set-default',
  name:'B·ªô chi√™ng m·∫´u (tham kh·∫£o)',
  items:[
    {id:'chieng-cha',label:'Chi√™ng Cha',freq:110},
    {id:'chieng-me',label:'Chi√™ng M·∫π',freq:130.81},
    {id:'chieng-1',label:'Chi√™ng 1',freq:146.83},
    {id:'chieng-2',label:'Chi√™ng 2',freq:174.61},
    {id:'chieng-3',label:'Chi√™ng 3',freq:196.00},
    {id:'chieng-4',label:'Chi√™ng 4',freq:233.08},
  ]
};
function loadSets(){
  try{
    const raw=localStorage.getItem(LS_KEY);
    if(!raw) return [DEFAULT_SET];
    const j=JSON.parse(raw);
    return j && j.length? j:[DEFAULT_SET];
  }catch{return [DEFAULT_SET];}
}
function saveSets(s){ try{localStorage.setItem(LS_KEY,JSON.stringify(s));}catch{} }

/* ==== Pitch detection ==== */
function estimatePitchAutoCorrelation(buf, sr){
  const N = buf.length;
  if (N < 1024) return { f0: null, quality: 0 };

  let mean = 0;
  for (let i = 0; i < N; i++) mean += buf[i];
  mean /= N;
  const w = new Float32Array(N);
  for (let i = 0; i < N; i++) {
    const win = 0.5 * (1 - Math.cos(2 * Math.PI * i / (N - 1)));
    w[i] = (buf[i] - mean) * win;
  }

  const acf = new Float32Array(N);
  for (let lag = 0; lag < N; lag++) {
    let s = 0;
    for (let i = 0; i < N - lag; i++) s += w[i] * w[i + lag];
    acf[lag] = s;
  }

  const minF = 80;
  const maxF = 800;
  let startLag = Math.floor(sr / maxF); if (startLag < 2) startLag = 2;
  const minLag = Math.floor(sr / minF);

  const norm = acf[0] || 1;
  let peakLag = -1;
  let peakVal = -Infinity;

  for (let lag = startLag; lag < Math.min(minLag, N - 1); lag++) {
    const v = acf[lag] / norm;
    if (v > peakVal) {
      peakVal = v;
      peakLag = lag;
    }
  }

  if (peakLag <= 0) return { f0: null, quality: 0 };

  const i = peakLag;
  const y0 = acf[i - 1] || acf[i];
  const y1 = acf[i];
  const y2 = acf[i + 1] || acf[i];
  const denom = (y0 - 2 * y1 + y2);
  let shift = 0;
  if (Math.abs(denom) > 1e-12) shift = 0.5 * (y0 - y2) / denom;
  const refined = i + shift;
  const f = sr / refined;
  const quality = peakVal;

  if (!isFinite(f) || f <= 0) return { f0: null, quality: 0 };
  return { f0: f, quality };
}

function estimatePitchMultiFrame(buf, sr) {
  const N = buf.length;
  const minLen = 2048;
  if (N < minLen) return { f0: null, quality: 0 };

  const windowSize = Math.floor(N * 0.6);
  const step = Math.max(1, Math.floor((N - windowSize) / 2));
  const freqs = [];
  const quals = [];

  for (let start = 0; start + windowSize <= N; start += step) {
    const sub = buf.subarray(start, start + windowSize);
    const { f0, quality } = estimatePitchAutoCorrelation(sub, sr);
    if (f0 && isFinite(f0) && quality >= 0.35) {
      freqs.push(f0);
      quals.push(quality);
    }
  }

  if (!freqs.length) return { f0: null, quality: 0 };

  freqs.sort((a, b) => a - b);
  const mid = freqs[Math.floor(freqs.length / 2)];
  const avgQ = quals.reduce((a, b) => a + b, 0) / (quals.length || 1);

  return { f0: mid, quality: avgQ };
}

/* ==== EMA ==== */
class EMA{
  constructor(a=.25){ this.a=a; this.y=null; }
  push(x){
    if(x==null || !isFinite(x)) return this.y;
    this.y = this.y==null? x : this.a*x + (1-this.a)*this.y;
    return this.y;
  }
}

/* ==== FFT & ph·ªï ==== */
function nextPow2(n){ let p=1; while(p<n) p<<=1; return p; }
function hannWindow(N){ const w=new Float32Array(N); for(let i=0;i<N;i++) w[i]=0.5*(1-Math.cos(2*Math.PI*i/(N-1))); return w; }
function fftComplex(re,im){
  const n=re.length; let i=0,j=0;
  for(i=0;i<n;i++){
    if(j>i){
      let tr=re[j]; re[j]=re[i]; re[i]=tr;
      let ti=im[j]; im[j]=im[i]; im[i]=ti;
    }
    let m=n>>1;
    while(m>=1 && j>=m){ j-=m; m>>=1; }
    j+=m;
  }
  for(let len=2;len<=n;len<<=1){
    const ang=-2*Math.PI/len;
    const wRe=Math.cos(ang),wIm=Math.sin(ang);
    for(let i2=0;i2<n;i2+=len){
      let wr=1,wi=0;
      for(let k=0;k<(len>>1);k++){
        const uRe=re[i2+k],uIm=im[i2+k];
        const vRe=re[i2+k+(len>>1)]*wr - im[i2+k+(len>>1)]*wi;
        const vIm=re[i2+k+(len>>1)]*wi + im[i2+k+(len>>1)]*wr;
        re[i2+k]=uRe+vRe; im[i2+k]=uIm+vIm;
        re[i2+k+(len>>1)]=uRe-vRe; im[i2+k+(len>>1)]=uIm-vIm;
        const nwr=wr*wRe - wi*wIm; wi=wr*wIm + wi*wRe; wr=nwr;
      }
    }
  }
}
function magSpectrum(signal,sr){
  const N0=signal.length; const N=nextPow2(N0);
  const win=hannWindow(Math.min(N0,N));
  const re=new Float32Array(N), im=new Float32Array(N);
  for(let i=0;i<Math.min(N0,N);i++) re[i]=signal[i]*win[i];
  fftComplex(re,im);
  const half=N/2; const mags=new Float32Array(half); const freqs=new Float32Array(half);
  let maxMag=EPS;
  for(let i=0;i<half;i++){
    const m=Math.hypot(re[i],im[i]); mags[i]=m; if(m>maxMag) maxMag=m;
    freqs[i]=(i/half)*(sr/2);
  }
  for(let i=0;i<half;i++) mags[i]=20*Math.log10(Math.max(mags[i]/maxMag,EPS));
  return {freqs,mags};
}
function spectralCentroidFromMag(freqs,mags){
  let num=0,den=0;
  for(let i=0;i<freqs.length;i++){
    const lin=Math.pow(10,mags[i]/20);
    num+=freqs[i]*lin; den+=lin;
  }
  return den>0? num/den:0;
}
function estimateF0FromSpectrum(freqs,mags){
  const minF=80, maxF=800;
  let maxMag=-Infinity;
  for(let i=0;i<freqs.length;i++){
    if(freqs[i]<minF || freqs[i]>maxF) continue;
    if(mags[i]>maxMag) maxMag=mags[i];
  }
  if(!isFinite(maxMag)) return null;
  let threshold=maxMag-20;
  let idx=-1;
  for(let i=1;i<freqs.length-1;i++){
    if(freqs[i]<minF || freqs[i]>maxF) continue;
    if(mags[i]>=threshold && mags[i]>mags[i-1] && mags[i]>=mags[i+1]){
      idx=i; break;
    }
  }
  if(idx<0){
    threshold=maxMag-30;
    for(let i=1;i<freqs.length-1;i++){
      if(freqs[i]<minF || freqs[i]>maxF) continue;
      if(mags[i]>=threshold && mags[i]>mags[i-1] && mags[i]>=mags[i+1]){
        idx=i; break;
      }
    }
  }
  if(idx<0) return null;
  const alpha=mags[idx-1], beta=mags[idx], gamma=mags[idx+1];
  const denom=(alpha-2*beta+gamma); let p=0;
  if(Math.abs(denom)>1e-12) p=0.5*(alpha-gamma)/denom;
  const df=freqs[idx+1]-freqs[idx];
  const f=freqs[idx]+p*df;
  return f;
}

/* ==== RT60 t·ª´ buffer ==== */
function estimateRT60FromBuffer(buf,sr){
  const hop=Math.floor(0.01*sr), win=Math.floor(0.05*sr);
  const levels=[];
  for(let p=0;p+win<=buf.length;p+=hop){
    const sl=buf.subarray(p,p+win);
    levels.push(toDB(rms(sl)));
  }
  if(levels.length<20) return {rt60:null,method:null};
  const maxDb=Math.max(...levels);
  const rel=levels.map((db,i)=>({t:i*0.01, db:db-maxDb}));
  let lo=-35,hi=-5,method='T30√ó2';
  let seg=rel.filter(d=>d.db<=hi && d.db>=lo);
  if(seg.length<20){
    lo=-25; hi=-5; method='T20√ó3';
    seg=rel.filter(d=>d.db<=hi && d.db>=lo);
  }
  if(seg.length<10) return {rt60:null,method:null};
  const x=seg.map(d=>d.t), y=seg.map(d=>d.db);
  const slope=(y[y.length-1]-y[0])/(x[x.length-1]-x[0]+1e-9);
  const rt60=-60/slope;
  return {rt60,method};
}

/* ==== App State ==== */
let audioCtx=null, analyser=null, fanalyser=null, micSource=null, micStream=null, raf=0;
const timeBuf=new Float32Array(4096);
const ema=new EMA(.25);
let isRunning=false;
let sets=loadSets();
let activeSetId=sets[0].id;
let activeItemId=sets[0].items[0]?.id;
let isCapturingDecay=false; let decayStart=0; const decayData=[];
let externalSpectrum=null;
let fileSummary=null;

let centsWindow=[];
const CENTS_WINDOW_SIZE=15;
let lastLevelDb=-Infinity;
let lastSmoothF0=0;

/* ==== DOM ==== */
const selSet=document.getElementById('selSet');
const selItem=document.getElementById('selItem');
const inpTargetHz=document.getElementById('inpTargetHz');
const btnAddSet=document.getElementById('btnAddSet');
const btnAddItem=document.getElementById('btnAddItem');
const btnStart=document.getElementById('btnStart');
const btnStop=document.getElementById('btnStop');
const btnRecordRef=document.getElementById('btnRecordRef');
const measHzEl=document.getElementById('measHz');
const targetHzEl=document.getElementById('targetHz');
const detuneEl=document.getElementById('detune');
const stabilityTxt=document.getElementById('stabilityTxt');
const needleEl=document.getElementById('needle');
const specCanvas=document.getElementById('specCanvas');
const centroidHzEl=document.getElementById('centroidHz');
const tableBody=document.getElementById('tableBody');
const fileInput=document.getElementById('fileInput');
const fileSummaryBox=document.getElementById('fileSummary');
const sumName=document.getElementById('sumName');
const sumF0=document.getElementById('sumF0');
const sumCentroid=document.getElementById('sumCentroid');
const sumRT60=document.getElementById('sumRT60');
const btnStartDecay=document.getElementById('btnStartDecay');
const btnStopDecay=document.getElementById('btnStopDecay');
const rt60Mic=document.getElementById('rt60Mic');
const rtMethod=document.getElementById('rtMethod');
const rt60File=document.getElementById('rt60File');
const adviceBox=document.getElementById('adviceBox');
const adviceTitle=document.getElementById('adviceTitle');
const adviceDetail=document.getElementById('adviceDetail');
const btnQuickDecay=document.getElementById('btnQuickDecay');
const micStatus=document.getElementById('micStatus');

/* Canvas cho ph·ªï */
function initSpectrumCanvas(){
  const dpr=Math.max(1,window.devicePixelRatio||1);
  const w=specCanvas.clientWidth || specCanvas.parentElement.clientWidth || 300;
  const h=180;
  specCanvas.width=Math.floor(w*dpr);
  specCanvas.height=Math.floor(h*dpr);
  specCanvas.style.height=h+'px';
  const ctx=specCanvas.getContext('2d');
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr,dpr);
}
initSpectrumCanvas();
window.addEventListener('resize', ()=> {
  initSpectrumCanvas();
});

/* Render B·ªô chi√™ng */
function renderSets(){
  selSet.innerHTML=sets.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  selSet.value=activeSetId;
  renderItems();
}
function renderItems(){
  const set=sets.find(s=>s.id===activeSetId)||sets[0];
  selItem.innerHTML=set.items.map(i=>`<option value="${i.id}">${i.label}</option>`).join('');
  if(!set.items.find(i=>i.id===activeItemId)) activeItemId=set.items[0]?.id;
  selItem.value=activeItemId;
  const it=set.items.find(i=>i.id===activeItemId);
  inpTargetHz.value=it? it.freq:0;
  targetHzEl.textContent=it? it.freq.toFixed(2)+' Hz':'‚Äî Hz';
  renderTable();
}
function renderTable(){
  const set=sets.find(s=>s.id===activeSetId)||sets[0];
  tableBody.innerHTML=set.items.map(it=>`
    <tr>
      <td><input data-id="${it.id}" data-kind="label" class="field" value="${it.label}"/></td>
      <td><input data-id="${it.id}" data-kind="freq" class="field" type="number" step="0.01" value="${it.freq}"/></td>
      <td><button data-id="${it.id}" data-kind="select" class="btn ghost sm" style="padding-inline:8px;">Ch·ªçn</button></td>
    </tr>
  `).join('');
}
function saveAndRender(){ saveSets(sets); renderSets(); }

/* Giao di·ªán ƒëi·ªÅu khi·ªÉn B·ªô chi√™ng */
btnAddSet.onclick=()=>{
  const name=prompt('T√™n b·ªô chi√™ng m·ªõi?'); if(!name) return;
  const id='set-'+Date.now();
  sets=[...sets,{id,name,items:[]}];
  activeSetId=id;
  saveAndRender();
};
btnAddItem.onclick=()=>{
  const set=sets.find(s=>s.id===activeSetId);
  const id='gong-'+Date.now();
  set.items.push({id,label:'Chi√™ng m·ªõi',freq:150});
  activeItemId=id;
  saveAndRender();
};
selSet.onchange=e=>{
  activeSetId=e.target.value;
  renderItems();
  saveSets(sets);
};
selItem.onchange=e=>{
  activeItemId=e.target.value;
  const set=sets.find(s=>s.id===activeSetId);
  const it=set.items.find(i=>i.id===activeItemId);
  inpTargetHz.value=it.freq;
  targetHzEl.textContent=it.freq.toFixed(2)+' Hz';
};
document.addEventListener('input',e=>{
  if(e.target===inpTargetHz){
    const v=parseFloat(e.target.value)||0;
    const set=sets.find(s=>s.id===activeSetId);
    const it=set.items.find(i=>i.id===activeItemId);
    it.freq=v;
    targetHzEl.textContent=v? v.toFixed(2)+' Hz':'‚Äî Hz';
    saveSets(sets);
  }
  if(e.target && e.target.dataset && e.target.dataset.kind){
    const kind=e.target.dataset.kind;
    const id=e.target.dataset.id;
    const set=sets.find(s=>s.id===activeSetId);
    const it=set.items.find(i=>i.id===id);
    if(!it) return;
    if(kind==='label') it.label=e.target.value;
    if(kind==='freq') it.freq=parseFloat(e.target.value)||0;
    saveSets(sets);
    if(id===activeItemId && kind==='freq'){
      targetHzEl.textContent=it.freq? it.freq.toFixed(2)+' Hz':'‚Äî Hz';
    }
  }
});
document.addEventListener('click',e=>{
  if(e.target && e.target.dataset && e.target.dataset.kind==='select'){
    activeItemId=e.target.dataset.id;
    selItem.value=activeItemId;
    const set=sets.find(s=>s.id===activeSetId);
    const it=set.items.find(i=>i.id===activeItemId);
    inpTargetHz.value=it.freq;
    targetHzEl.textContent=it.freq.toFixed(2)+' Hz';
  }
});

/* ====== Audio / Mic setup ====== */
async function setupMicStream(stream){
  micStream = stream;
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 4096;
  analyser.smoothingTimeConstant = 0.0;

  fanalyser = audioCtx.createAnalyser();
  fanalyser.fftSize = 4096;
  fanalyser.minDecibels = -100;
  fanalyser.maxDecibels = -10;
  fanalyser.smoothingTimeConstant = 0.7;

  micSource = audioCtx.createMediaStreamSource(stream);
  micSource.connect(analyser);
  micSource.connect(fanalyser);
}

async function requestMicOnce(){
  if(micSource && audioCtx) return;
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      audio:true
    });
    await setupMicStream(stream);
    micStatus.textContent = 'Mic: ƒë√£ c·∫•p quy·ªÅn, s·∫µn s√†ng ƒëo.';
  }catch(err){
    console.warn('Kh√¥ng l·∫•y ƒë∆∞·ª£c quy·ªÅn mic:', err);
    micStatus.textContent = 'Mic: l·ªói ho·∫∑c b·ªã t·ª´ ch·ªëi (xem l·∫°i quy·ªÅn trong tr√¨nh duy·ªát).';
    alert('Tr√¨nh duy·ªát kh√¥ng cho d√πng mic. H√£y ki·ªÉm tra:\n- Trang ph·∫£i ch·∫°y tr√™n https (v√≠ d·ª•: https://khktbuithanhluan)\n- Tr√¨nh duy·ªát ƒë√£ c·∫•p quy·ªÅn microphone.');
  }
}

/* B·∫≠t/D·ª´ng tuner */
btnStart.onclick = async () => {
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    alert('Tr√¨nh duy·ªát n√†y kh√¥ng h·ªó tr·ª£ getUserMedia / microphone.');
    return;
  }
  await requestMicOnce();
  if(!audioCtx || !analyser){
    return;
  }
  if(audioCtx.state === 'suspended'){
    try{ await audioCtx.resume(); }catch(e){ console.warn('Resume AudioContext l·ªói:', e); }
  }
  if(isRunning) return;
  isRunning = true;
  micStatus.textContent = 'Mic: ƒëang ƒëo (h√£y g√µ chi√™ng).';
  tick();
};

btnStop.onclick = () => {
  isRunning = false;
  cancelAnimationFrame(raf);
  micStatus.textContent = 'Mic: ƒë√£ d·ª´ng ƒëo.';
};

/* Ghi ~5s l√†m chu·∫©n */
btnRecordRef.onclick = async () => {
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    alert('Tr√¨nh duy·ªát n√†y kh√¥ng h·ªó tr·ª£ microphone.');
    return;
  }
  await requestMicOnce();
  if(!audioCtx || !analyser || !micSource){
    alert('Mic ch∆∞a s·∫µn s√†ng.');
    return;
  }
  if(audioCtx.state === 'suspended'){
    try{ await audioCtx.resume(); }catch(e){ console.warn('Resume AudioContext l·ªói:', e); }
  }

  if(!isRunning){
    isRunning = true;
    tick();
  }

  const samples = [];
  const durationMs = 5000;
  const start = performance.now();
  const minLevelDb = -45;

  function collect(){
    if(!audioCtx || !analyser) return;
    const now = performance.now();
    if(now - start > durationMs || samples.length >= 200){
      const valid = samples.filter(f => f > 0).sort((a,b)=>a-b);
      const mid = valid.length ? valid[Math.floor(valid.length/2)] : 0;
      if(mid > 0){
        const set = sets.find(s=>s.id===activeSetId);
        const it  = set.items.find(i=>i.id===activeItemId);
        it.freq = Math.round(mid*100)/100;
        saveSets(sets);
        renderItems();
        alert('ƒê√£ l·∫•y chu·∫©n ‚âà ' + it.freq.toFixed(2) + ' Hz cho ' + it.label);
      }else{
        alert('Kh√¥ng b·∫Øt ƒë∆∞·ª£c √¢m ·ªïn ƒë·ªãnh. H√£y g√µ l·∫°i chi√™ng v√† th·ª≠ ‚ÄúGhi √¢m l√†m chu·∫©n‚Äù l·∫ßn n·ªØa.');
      }
      return;
    }

    if(lastSmoothF0 > 0 && lastLevelDb > minLevelDb){
      samples.push(lastSmoothF0);
    }
    setTimeout(collect, 40);
  }

  samples.length = 0;
  collect();
};

/* RT60 t·ª´ mic */
btnStartDecay.onclick=()=>{
  if(!audioCtx || !analyser){
    alert('Mic ch∆∞a s·∫µn s√†ng ho·∫∑c ch∆∞a b·∫•m B·∫Øt ƒë·∫ßu.');
    return;
  }
  isCapturingDecay=true;
  decayStart=performance.now();
  decayData.length=0;
  rt60Mic.textContent='‚Äî';
  rtMethod.textContent='‚Äî';
};
btnStopDecay.onclick=finalizeDecay;
btnQuickDecay.onclick=()=>btnStartDecay.click();

function finalizeDecay(){
  isCapturingDecay=false;
  if(decayData.length<20){
    rt60Mic.textContent='‚Äî';
    rtMethod.textContent='‚Äî';
    return;
  }
  const maxDb=Math.max(...decayData.map(d=>d.db));
  const rel=decayData.map(d=>({t:d.t, db:d.db-maxDb}));
  let lo=-35,hi=-5,method='T30√ó2';
  let seg=rel.filter(d=>d.db<=hi && d.db>=lo);
  if(seg.length<20){
    lo=-25; hi=-5; method='T20√ó3';
    seg=rel.filter(d=>d.db<=hi && d.db>=lo);
  }
  if(seg.length<10){
    rt60Mic.textContent='‚Äî';
    rtMethod.textContent='‚Äî';
    return;
  }
  const x=seg.map(d=>d.t), y=seg.map(d=>d.db);
  const slope=(y[y.length-1]-y[0])/(x[x.length-1]-x[0]+1e-9);
  const rt60=-60/slope;
  if(rt60>0 && isFinite(rt60)){
    rt60Mic.textContent=rt60.toFixed(2)+' s';
    let cat='';
    if(rt60<0.8) cat='‚Äì ƒê·ªô ng√¢n ng·∫Øn (chi√™ng √≠t vang)';
    else if(rt60<1.6) cat='‚Äì ƒê·ªô ng√¢n v·ª´a (ph√π h·ª£p nhi·ªÅu ho√†n c·∫£nh)';
    else cat='‚Äì ƒê·ªô ng√¢n d√†i (chi√™ng vang nhi·ªÅu, h·ª£p nghi l·ªÖ l·ªõn)';
    rtMethod.textContent=method+' '+cat;
  }else{
    rt60Mic.textContent='‚Äî';
    rtMethod.textContent=method;
  }
}

/* Upload file ‚Äì ph√¢n t√≠ch ph·ªï */
fileInput.addEventListener('change',async e=>{
  const f=e.target.files&&e.target.files[0]; if(!f) return;
  try{
    const arr=await f.arrayBuffer();
    const ctx=audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const decoded=await ctx.decodeAudioData(arr.slice(0));
    const ch=decoded.getChannelData(0);
    const sr=decoded.sampleRate;

    const totalDur=decoded.duration;
    const segDur=Math.min(1.0,totalDur*0.6);
    const startTime=totalDur>1.5? totalDur*0.2 : Math.max(0,(totalDur-segDur)/2);
    const startSample=Math.floor(startTime*sr);
    const segSamples=Math.min(Math.floor(segDur*sr), ch.length-startSample);
    const seg=ch.subarray(startSample,startSample+segSamples);

    const {freqs,mags}=magSpectrum(seg,sr);
    let f0Spec=estimateF0FromSpectrum(freqs,mags);
    const centroid=spectralCentroidFromMag(freqs,mags);
    const {rt60,method}=estimateRT60FromBuffer(ch,sr);

    const set=sets.find(s=>s.id===activeSetId);
    const it=set ? set.items.find(i=>i.id===activeItemId) : null;
    const target=it ? it.freq : 0;
    f0Spec=snapToTargetHarmonic(f0Spec,target);

    externalSpectrum={freqs:Array.from(freqs), mags:Array.from(mags)};
    fileSummary={name:f.name,f0:f0Spec||0,centroid,rt60,method};

    fileSummaryBox.style.display='grid';
    sumName.textContent=f.name;
    sumF0.textContent=f0Spec? f0Spec.toFixed(2)+' Hz':'‚Äî';
    sumCentroid.textContent=centroid? centroid.toFixed(1)+' Hz':'‚Äî';
    sumRT60.textContent=rt60? rt60.toFixed(2)+' s':'‚Äî';
    rt60File.textContent=rt60? rt60.toFixed(2)+' s':'‚Äî';
    centroidHzEl.textContent=centroid? centroid.toFixed(1):'‚Äî';

    drawSpectrum();

    if(f0Spec>0 && it){
      if(confirm(`Ph√°t hi·ªán f0 (t·ª´ ph·ªï) ‚âà ${f0Spec.toFixed(2)} Hz.\nƒê·∫∑t l√†m t·∫ßn s·ªë m·ª•c ti√™u cho "${it.label}"?`)){
        it.freq=Math.round(f0Spec*100)/100;
        saveSets(sets);
        renderItems();
      }
    }
  }catch(err){
    console.error(err);
    alert('Kh√¥ng th·ªÉ ph√¢n t√≠ch file √¢m thanh. Vui l√≤ng d√πng WAV/MP3 h·ª£p l·ªá.');
  }
});

/* V·∫Ω ph·ªï */
function drawSpectrum(){
  const ctx=specCanvas.getContext('2d');
  const w=specCanvas.clientWidth, h=180;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle='#f8fafb';
  ctx.fillRect(0,0,w,h);
  ctx.strokeStyle='#e2e8f0';
  ctx.beginPath(); ctx.moveTo(0,h-0.5); ctx.lineTo(w,h-0.5); ctx.stroke();

  if(externalSpectrum){
    const freqs=externalSpectrum.freqs, mags=externalSpectrum.mags;
    const ny=Math.max(...freqs);
    ctx.beginPath();
    for(let i=0;i<freqs.length;i++){
      const x=(freqs[i]/ny)*w;
      const y=h - (Math.min(Math.max(mags[i],-100),-10)+100)/90*h;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.strokeStyle='#2563eb';
    ctx.lineWidth=1.4;
    ctx.stroke();
    const centroid=parseFloat(centroidHzEl.textContent)||0;
    const cx=(centroid/ny)*w;
    ctx.setLineDash([4,3]); ctx.strokeStyle='#94a3b8';
    ctx.beginPath(); ctx.moveTo(cx,0); ctx.lineTo(cx,h); ctx.stroke();
    ctx.setLineDash([]);
    return;
  }

  if(!fanalyser || !audioCtx) return;
  const N=fanalyser.frequencyBinCount;
  const fb=new Float32Array(N);
  fanalyser.getFloatFrequencyData(fb);
  const ny=(audioCtx.sampleRate||48000)/2;
  let num=0,den=0;
  for(let i=0;i<N;i++){
    const f=(i/N)*ny;
    const mag=fromDB(fb[i]-fanalyser.minDecibels);
    num+=f*mag; den+=mag;
  }
  const centroid=den>0? num/den:0;
  centroidHzEl.textContent=centroid? centroid.toFixed(1):'‚Äî';
  ctx.beginPath();
  for(let i=0;i<N;i++){
    const x=(i/(N-1))*w;
    const y=h - (Math.min(Math.max(fb[i],-100),-10)+100)/90*h;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.strokeStyle='#2563eb';
  ctx.lineWidth=1.4;
  ctx.stroke();
  const cx=(centroid/ny)*w;
  ctx.setLineDash([4,3]); ctx.strokeStyle='#94a3b8';
  ctx.beginPath(); ctx.moveTo(cx,0); ctx.lineTo(cx,h); ctx.stroke();
  ctx.setLineDash([]);
}

/* G·ª£i √Ω ch·ªânh s·ª≠a */
function updateAdvice(smoothFreq, targetFreq, cents, stability){
  const hasTarget = targetFreq > 0;
  const enoughSamples = centsWindow.length >= 5;
  const hasPitch = smoothFreq > 0;

  const diffHz   = (hasPitch && hasTarget) ? (smoothFreq - targetFreq) : 0;
  const absHz    = Math.abs(diffHz);
  const absCents = Math.abs(cents || 0);

  if (!hasTarget) {
    adviceBox.style.background = '#f9fafb';
    adviceBox.style.border = '1px dashed #cbd5f5';
    adviceTitle.textContent = 'Ch∆∞a c√≥ chu·∫©n ƒë·ªÉ so s√°nh.';
    adviceDetail.textContent = 'H√£y nh·∫≠p T·∫ßn s·ªë m·ª•c ti√™u (Hz) ho·∫∑c b·∫•m ‚ÄúGhi √¢m l√†m chu·∫©n (‚âà5s)‚Äù tr∆∞·ªõc.';
    return;
  }

  if (!hasPitch || !enoughSamples) {
    adviceBox.style.background = '#f9fafb';
    adviceBox.style.border = '1px dashed #cbd5f5';
    adviceTitle.textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªß ·ªïn ƒë·ªãnh.';
    adviceDetail.textContent = 'H√£y g√µ chi√™ng 2‚Äì3 l·∫ßn, gi·ªØ kho·∫£ng c√°ch mic c·ªë ƒë·ªãnh ƒë·ªÉ h·ªá th·ªëng b·∫Øt ƒë∆∞·ª£c √¢m ·ªïn ƒë·ªãnh.';
    return;
  }

  let status = '';
  let colorBg = '';
  let colorBorder = '';
  let detail = '';

  if (absHz <= 5) {
    status      = 'ƒê√É G·∫¶N NH∆Ø CHU·∫®N';
    colorBg     = '#dcfce7';
    colorBorder = '#16a34a';
    detail      = `Chi√™ng g·∫ßn tr√πng v·ªõi chu·∫©n. ƒê·ªô l·ªách ‚âà ${diffHz.toFixed(2)} Hz (${cents.toFixed(1)}¬¢). V·ªõi d√†n chi√™ng th·ª±c t·∫ø, m·ª©c n√†y ƒë√£ c√≥ th·ªÉ xem l√† ƒë·∫°t.`;
  } else if (absHz <= 15) {
    status      = diffHz < 0 ? 'H∆†I TR·∫¶M' : 'H∆†I CAO';
    colorBg     = '#fef9c3';
    colorBorder = '#eab308';
    detail      = `Chi√™ng ƒëang ${diffHz < 0 ? 'tr·∫ßm h∆°n' : 'cao h∆°n'} chu·∫©n ‚âà ${absHz.toFixed(2)} Hz (${absCents.toFixed(1)}¬¢). N√™n nghe th·ª≠ c√πng c√°c chi√™ng kh√°c trong d√†n ‚Äì n·∫øu c·∫£m gi√°c v·∫´n ho√† th√¨ c√≥ th·ªÉ gi·ªØ nguy√™n, n·∫øu ‚Äúg·ª£n‚Äù th√¨ ch·ªânh nh·∫π.`;
  } else if (absHz <= 30) {
    status      = diffHz < 0 ? 'L·ªÜCH TH·∫§Y R√ï ‚Äì TR·∫¶M' : 'L·ªÜCH TH·∫§Y R√ï ‚Äì CAO';
    colorBg     = '#fee2e2';
    colorBorder = '#f97316';
    detail      = `Chi√™ng ${diffHz < 0 ? 'tr·∫ßm h∆°n' : 'cao h∆°n'} kh√° r√µ ‚âà ${absHz.toFixed(2)} Hz (${absCents.toFixed(1)}¬¢). N√™n tham kh·∫£o ngh·ªá nh√¢n ƒë·ªÉ ch·ªânh v·∫≠t l√Ω ho·∫∑c c√¢n nh·∫Øc ƒë·ªïi chi√™ng kh√°c.`;
  } else {
    status      = 'L·ªÜCH NHI·ªÄU ‚Äì CH·ªà N√äN D√ôNG RI√äNG L·∫∫';
    colorBg     = '#fee2e2';
    colorBorder = '#dc2626';
    detail      = `Sai s·ªë l·ªõn ‚âà ${absHz.toFixed(2)} Hz (${absCents.toFixed(1)}¬¢). Chi√™ng n√†y kh√≥ ho√† trong d√†n n·∫øu ch∆∞a ch·ªânh s·ª≠a l·∫°i, ch·ªâ n√™n d√πng cho m·ª•c ƒë√≠ch ri√™ng l·∫ª.`;
  }

  adviceBox.style.background = colorBg;
  adviceBox.style.border     = '1px solid ' + colorBorder;
  adviceTitle.textContent    = status;
  adviceDetail.textContent   = detail;
}

/* Loop realtime */
function getActiveItem(){
  const set=sets.find(s=>s.id===activeSetId);
  if(!set) return null;
  return set.items.find(i=>i.id===activeItemId)||null;
}

function tick(){
  if (!isRunning || !audioCtx || !analyser) return;

  analyser.getFloatTimeDomainData(timeBuf);
  const sr = audioCtx.sampleRate;
  let buf = timeBuf;
  let effSr = sr;

  if (sr > 32000) {
    const half = new Float32Array(timeBuf.length / 2);
    for (let i = 0; i < half.length; i++) half[i] = timeBuf[i * 2];
    buf = half;
    effSr = sr / 2;
  }

  const item   = getActiveItem();
  const target = item ? item.freq : 0;

  const level = rms(timeBuf);
  const levelDb = toDB(level);
  lastLevelDb = levelDb;

  let rawF0 = null;
  let quality = 0;

  if (levelDb > -60) {
    const res = estimatePitchMultiFrame(buf, effSr);
    rawF0 = res.f0;
    quality = res.quality || 0;
  }

  if (!rawF0 || !isFinite(rawF0) || quality < 0.35) {
    rawF0 = null;
  }

  let f0 = snapToTargetHarmonic(rawF0, target);
  const smooth = ema.push(f0);
  lastSmoothF0 = smooth || 0;

  let conf = quality;
  if (f0 && smooth) {
    const dev = Math.abs(f0 - smooth) / (smooth + 1e-6);
    const stableFactor = 1 / (1 + dev);
    conf = 0.6 * quality + 0.4 * stableFactor;
  }

  const rawCents = centsDiff(smooth || 0, target || 0);

  if (smooth && target) {
    centsWindow.push(rawCents);
    if (centsWindow.length > CENTS_WINDOW_SIZE) centsWindow.shift();
  }

  measHzEl.textContent = smooth ? smooth.toFixed(2) + ' Hz' : '‚Äî Hz';
  detuneEl.textContent = isFinite(rawCents) ? rawCents.toFixed(1) + '¬¢' : '‚Äî¬¢';
  stabilityTxt.textContent = 'ƒê·ªô ·ªïn ƒë·ªãnh: ' + Math.round((conf || 0) * 100) + '%';

  needleEl.style.transform = 'rotate(' + (clamp(rawCents, -100, 100) * 0.9) + 'deg)';

  if (isCapturingDecay) {
    const t = (performance.now() - decayStart) / 1000;
    const levelDb2 = toDB(rms(timeBuf));
    decayData.push({ t, db: levelDb2 });
    if (t >= 5) finalizeDecay();
  }

  let avgCents = 0;
  if (centsWindow.length) {
    avgCents = centsWindow.reduce((a, b) => a + b, 0) / centsWindow.length;
  }
  updateAdvice(smooth || 0, target || 0, avgCents || 0, conf || 0);

  externalSpectrum = null;
  drawSpectrum();

  raf = requestAnimationFrame(tick);
}

/* init */
renderSets();
</script>
</body>
</html>
